apiVersion: v1
kind: ConfigMap
metadata:
  name: woocommerce-init
  labels:
    app: wordpress
data:
  setup-woocommerce.sh: |
    #!/bin/bash
    set -e
    set -x  # Trace for troubleshooting.

    # Simple lock so the script doesn't run twice.
    LOCK_FILE="/tmp/woocommerce-setup.lock"

    if ! mkdir "$LOCK_FILE" 2>/dev/null; then
        echo "Setup script is already running (lock file exists). Exiting to prevent duplicates."
        exit 0
    fi

    # Always release the lock.
    trap 'rmdir "$LOCK_FILE" 2>/dev/null || true' EXIT

    # Run in the background so container startup isn't blocked.
    (
        echo "=== WooCommerce Auto-Setup Starting ==="

        MAX_RETRIES=60
        RETRY_COUNT=0
        until curl -sf http://localhost:8080/ > /dev/null; do
          echo "Waiting for WordPress to be ready... (${RETRY_COUNT}/${MAX_RETRIES})"
          sleep 5
          RETRY_COUNT=$((RETRY_COUNT + 1))
          if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
            echo "ERROR: WordPress failed to start after ${MAX_RETRIES} retries"
            exit 1
          fi
        done

        echo "WordPress is ready! Starting WooCommerce configuration..."

        # WP-CLI runs as root in this container.
        WP="/opt/bitnami/wp-cli/bin/wp --path=/opt/bitnami/wordpress --allow-root"

        # Plugin install can be flaky on first boot, so retry a few times.
        echo "Installing WooCommerce plugin..."
        n=0
        until [ "$n" -ge 5 ]
        do
           $WP plugin install woocommerce --activate && break
           n=$((n+1))
           echo "Install failed, retrying in 10s... ($n/5)"
           sleep 10
        done
        if [ "$n" -ge 5 ]; then
           echo "ERROR: Failed to install WooCommerce after 5 attempts"
           exit 1
        fi
        echo "✓ WooCommerce installed and activated"

        echo "Installing Storefront theme..."
        n=0
        until [ "$n" -ge 5 ]
        do
           $WP theme install storefront --activate && break
           n=$((n+1))
           echo "Install failed, retrying in 10s... ($n/5)"
           sleep 10
        done
        if [ "$n" -ge 5 ]; then
           echo "ERROR: Failed to install Storefront theme after 5 attempts"
           exit 1
        fi
        echo "✓ Storefront theme activated"

        echo "Configuring permalinks..."
        $WP rewrite structure "/%postname%/" || true
        $WP rewrite flush || true
        echo "✓ Permalinks configured"

        echo "Creating WooCommerce pages..."
        $WP wc tool run install_pages --user=admin || {
          echo "WARNING: Failed to create WooCommerce pages, continuing..."
        }
        echo "✓ WooCommerce pages created"

        echo "Cleaning up default sample content..."
        $WP post delete $($WP post list --post_type=product --format=ids) --force || true
        $WP post delete $($WP post list --post_type=post --format=ids) --force || true
        echo "✓ Sample content removed"

        echo "Enabling COD payment gateway..."
        $WP option update woocommerce_cod_settings '{"enabled":"yes","title":"Payment (Only COD Available)","description":"We currently only support Cash on Delivery."}' --format=json || {
          echo "ERROR: Failed to enable COD"
          exit 1
        }
        echo "✓ COD payment enabled"

        # Don't create demo products twice.
        PRODUCT_COUNT=$($WP post list --post_type=product --format=count)
        if [ "$PRODUCT_COUNT" -gt 0 ]; then
            echo "✓ Products already exist ($PRODUCT_COUNT found), skipping product creation"
        else
            echo "Creating sample products..."
            $WP wc product create --name="Premium Cotton T-Shirt" --type=simple --regular_price=29.99 --description="High-quality cotton t-shirt, perfect for everyday wear" --short_description="Comfortable cotton t-shirt" --manage_stock=true --stock_quantity=50 --catalog_visibility=visible --status=publish --user=admin || echo "WARNING: Product 1 creation failed"
            $WP wc product create --name="Classic Blue Jeans" --type=simple --regular_price=59.99 --description="Classic fit blue jeans made from premium denim" --short_description="Durable denim jeans" --manage_stock=true --stock_quantity=30 --catalog_visibility=visible --status=publish --user=admin || echo "WARNING: Product 2 creation failed"
            $WP wc product create --name="Running Sneakers" --type=simple --regular_price=89.99 --description="Lightweight running sneakers with superior cushioning" --short_description="Comfortable running shoes" --manage_stock=true --stock_quantity=25 --catalog_visibility=visible --status=publish --user=admin || echo "WARNING: Product 3 creation failed"
            $WP wc product create --name="Travel Backpack" --type=simple --regular_price=49.99 --description="Spacious travel backpack with multiple compartments" --short_description="Versatile travel bag" --manage_stock=true --stock_quantity=40 --catalog_visibility=visible --status=publish --user=admin || echo "WARNING: Product 4 creation failed"
            $WP wc product create --name="Insulated Water Bottle" --type=simple --regular_price=19.99 --description="Keeps drinks cold for 24 hours or hot for 12 hours" --short_description="Insulated stainless steel bottle" --manage_stock=true --stock_quantity=100 --catalog_visibility=visible --status=publish --user=admin || echo "WARNING: Product 5 creation failed"
            
            echo "✓ Sample products created"
            FINAL_PRODUCT_COUNT=$($WP post list --post_type=product --format=count)
            echo "✓ Total products in database: ${FINAL_PRODUCT_COUNT}"
            echo "Clearing WooCommerce caches..."
            $WP cache flush || true
            $WP transient delete --all || true
            echo "✓ Caches cleared"
            # WooCommerce sometimes needs a lookup rebuild after bulk inserts.
            echo "Rebuilding product lookup table..."
            $WP wc tool run regenerate_product_lookup_tables --user=admin || {
              echo "WARNING: Failed to rebuild product lookup table, continuing..."
            }
            echo "✓ Product lookup table rebuilt"
        fi

        echo "Setting homepage to shop..."
        SHOP_PAGE_ID=$($WP post list --post_type=page --name=shop --field=ID --format=csv | tr -d '\r\n')
        if [ -n "$SHOP_PAGE_ID" ]; then
          $WP option update show_on_front page || true
          $WP option update page_on_front ${SHOP_PAGE_ID} || true
          echo "✓ Homepage set to shop page (ID: ${SHOP_PAGE_ID})"
        else
          echo "WARNING: Could not find shop page to set as homepage"
        fi

        echo "Configuring WooCommerce settings..."
        $WP option update woocommerce_default_country "US" || true
        $WP option update woocommerce_currency "USD" || true
        $WP option update woocommerce_calc_taxes "no" || true
        echo "✓ WooCommerce settings configured"

        echo "=== WooCommerce Setup Complete ==="
        echo "Store is ready for end-to-end order testing!"
    ) &
